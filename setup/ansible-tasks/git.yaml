---
# Downloads and installs git

- name: Git | fetch git releases HTML page
  local_action: shell curl -sL https://www.kernel.org/pub/software/scm/git/
  register: git_html_content
  tags: git

- name: Git | Extract latest version
  set_fact:
    git_latest: "{{ git_html_content.stdout | regex_findall('git-[0-9]+.[0-9]+(?:.[0-9]+)*.tar.gz') | map('regex_replace', 'git-') | map('regex_replace', '.tar.gz') | list | latest_version }}"
  tags: git

- name: Git | Check git --version
  shell: git --version
  ignore_errors: True
  register: installed_version
  tags: git

- name: Git | Compare installed version matches
  set_fact:
    git_proceed: "{{ installed_version.stdout.find(git_latest) == -1 }}"
  tags: git

- name: Git | Install required packages for git compile
  apt: name={{ item }} update_cache=yes state=latest
  with_items:
    - gcc
    - make
    - gettext
    - libcurl4-openssl-dev
    - zlib1g-dev
  when: git_proceed
  tags: git

- name: Git | Download git-{{ git_latest }}
  get_url: url=https://www.kernel.org/pub/software/scm/git/git-{{ git_latest }}.tar.xz dest=/tmp/
  register: new_archive
  when: git_proceed
  tags: git

- name: Git | Extract git-{{ git_latest }}
  unarchive: src=/tmp/git-{{ git_latest }}.tar.xz dest=/tmp/ copy=no
  when: git_proceed and new_archive|changed
  tags: git

- name: Git | Prepare for compilation by running configure
  shell: ./configure --prefix=/usr --with-gitconfig=/etc/gitconfig chdir=/tmp/git-{{ git_latest }} >> /dev/null
  when: git_proceed
  tags: git

- name: Git | Compile git
  shell: make -j{{ ansible_processor_vcpus }}
  args:
    chdir: /tmp/git-{{ git_latest }}
  when: git_proceed
  tags: git

- name: Git | Install generated binary
  command: make install
  args:
    chdir: /tmp/git-{{ git_latest }}
  when: git_proceed
  tags: git

- name: Git | Cleanup
  file: path="{{ item }}" state=absent
  with_items:
    - /tmp/git-{{ git_latest }}.tar.gz
    - /tmp/git-{{ git_latest }}
  when: git_proceed
  tags: git
